#!/bin/bash
set -e

APP_DIR="/opt/vrchat-api"
GIT_REPO="https://git.kvs.fyi/kryscau/VRChatAPI.git"
VERSION_FILE="$APP_DIR/version_git.txt"
VENV_DIR="$APP_DIR/venv"
REQUIREMENTS="$APP_DIR/requirements.txt"

if [ -z "$TOKEN_DOWNLOAD" ]; then
  echo "Error: TOKEN_DOWNLOAD is not set. Please provide the token."
  exit 1
fi

DOWNLOAD_ACCOUNT_URL="https://kvs.fyi/admin/api/vrcapi_download_acc.php?token=$TOKEN_DOWNLOAD"
ACCOUNT_JSON_PATH="$APP_DIR/data/auth/account.json"

echo "Creating app directory..."
mkdir -p "$APP_DIR"

if [ ! -d "$APP_DIR/.git" ]; then
  echo "Cloning repository..."
  git clone "$GIT_REPO" "$APP_DIR"
else
  echo "Repository already cloned, skipping."
fi

cd "$APP_DIR"
LATEST_VERSION=$(git rev-parse HEAD)
echo "$LATEST_VERSION" > "$VERSION_FILE"

if [ ! -d "$VENV_DIR" ]; then
  echo "Creating virtual environment..."
  python3 -m venv "$VENV_DIR"
fi

echo "Activating virtual environment and installing dependencies..."
source "$VENV_DIR/bin/activate"
pip install --upgrade pip
pip install -r "$REQUIREMENTS"

echo "Creating data/auth directory..."
mkdir -p "$(dirname "$ACCOUNT_JSON_PATH")"

echo "Downloading account.json..."
curl -fSL "$DOWNLOAD_ACCOUNT_URL" -o "$ACCOUNT_JSON_PATH"
if [ $? -ne 0 ]; then
  echo "Failed to download account.json"
  exit 1
fi

echo "Setting proper permissions..."
chown -R vrchatapi:vrchatapi "$APP_DIR"
chmod 600 "$ACCOUNT_JSON_PATH"

echo "Installation complete."
