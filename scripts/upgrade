#!/bin/bash
set -e

APP_DIR="/opt/vrchat-api"
GIT_REPO="https://git.kvs.fyi/kryscau/VRChatAPI_ynh.git"
VERSION_FILE="$APP_DIR/version_git.txt"
VENV_DIR="$APP_DIR/venv"
REQUIREMENTS="$APP_DIR/requirements.txt"

echo "Starting upgrade process..."

if [ ! -d "$APP_DIR/.git" ]; then
  echo "No git repo found, cloning fresh..."
  git clone "$GIT_REPO" "$APP_DIR"
else
  echo "Git repo found, fetching latest..."
  cd "$APP_DIR"
  git fetch --all
fi

# Get current installed commit id
CURRENT_VERSION=""
if [ -f "$VERSION_FILE" ]; then
  CURRENT_VERSION=$(cat "$VERSION_FILE")
fi

# Get latest remote commit id on main branch
LATEST_VERSION=$(git ls-remote "$GIT_REPO" refs/heads/main | awk '{print $1}')

echo "Current version: $CURRENT_VERSION"
echo "Latest version: $LATEST_VERSION"

if [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
  echo "Already up-to-date."
  exit 0
fi

# Pull latest changes
cd "$APP_DIR"
git reset --hard "$LATEST_VERSION"

echo "$LATEST_VERSION" > "$VERSION_FILE"

# Reinstall dependencies
if [ ! -d "$VENV_DIR" ]; then
  echo "Virtualenv not found, creating..."
  python3 -m venv "$VENV_DIR"
fi

echo "Activating virtualenv and installing dependencies..."
source "$VENV_DIR/bin/activate"
pip install -r "$REQUIREMENTS"

echo "Restarting systemd service..."
systemctl restart vrchat-api

echo "Upgrade completed successfully."
